<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ツールチップ表示（ターゲット/タイムボーナス/獲得GP）</title>
    <style>
      body {
        margin: 20px;
        font-family: sans-serif;
      }
      h1 {
        margin-bottom: 10px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      /*----------------------------------------------
      ギルド・ゲートの情報入力エリア
    ----------------------------------------------*/
      .guild-info,
      .gate-info {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        width: 300px;
      }
      .guild-info h2,
      .gate-info h2 {
        margin-top: 0;
      }
      .guild-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }
      .guild-row label {
        margin-right: 10px;
      }
      .guild-row input[type="number"] {
        width: 60px;
      }
      /*----------------------------------------------
      出撃コマンド作成フォーム
    ----------------------------------------------*/
      #attackForm {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        width: 300px;
      }
      #attackForm .guild-row {
        margin: 5px 0;
      }
      #attackForm label {
        margin-right: 6px;
      }
      /*----------------------------------------------
      コマンド（出撃・終了）カードエリア
    ----------------------------------------------*/
      #commandList {
        list-style-type: none;
        margin: 0;
        padding: 0;
        width: 300px;
        border: 1px solid #ccc;
        min-height: 400px;
        border-radius: 4px;
        position: relative; /* Tooltipの表示に備える */
      }
      .command-item {
        margin: 5px;
        padding: 8px;
        border-radius: 4px;
        color: #fff;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative; /* 各アイテム基準の絶対位置指定に備える */
      }
      .command-label {
        font-weight: bold;
      }
      /* ギルドごとにカード色を設定（サンプル） */
      .guild1 {
        background-color: #e74c3c;
      } /* 赤 */
      .guild2 {
        background-color: #3498db;
      } /* 青 */
      .guild3 {
        background-color: #2ecc71;
      } /* 緑 */
      .guild4 {
        background-color: #9b59b6;
      } /* 紫 */

      /*----------------------------------------------
      data-tooltip を使った簡易ツールチップ表示
    ----------------------------------------------*/
      .command-item[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%; /* カードの上側に出す場合 */
        left: 0;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 6px;
        border-radius: 4px;
        font-size: 14px;
        white-space: pre; /* \A(改行)を解釈 */
        transform: translateY(-4px);
      }
      /* ツールチップの矢印を付けたい場合は::beforeで三角形を表示など可能 */

      /*----------------------------------------------
      下部の最終結果表示
    ----------------------------------------------*/
      #resultArea {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        width: 640px;
      }
      #resultArea h3 {
        margin-top: 0;
      }
      .result-line {
        margin: 5px 0;
      }
      .result-line span {
        display: inline-block;
        width: 180px;
      }
      /*----------------------------------------------
      ドラッグ中の見た目
    ----------------------------------------------*/
      .drag-over {
        border: 2px dashed #333;
      }
    </style>
  </head>
  <body>
    <h1>コマンド毎のタイムボーナス＆ツールチップ表示</h1>
    <div class="container">
      <!-- ギルド・ゲートの入力エリア -->
      <div>
        <div class="guild-info">
          <h2>ギルド情報</h2>
          <!-- Guild1 -->
          <div class="guild-row">
            <label>Guild1 GP:</label
            ><input type="number" id="gp-g1" value="10000" />
          </div>
          <div class="guild-row">
            <label>Guild1 Combo:</label
            ><input type="number" id="combo-g1" value="10" />
          </div>
          <!-- Guild2 -->
          <div class="guild-row">
            <label>Guild2 GP:</label
            ><input type="number" id="gp-g2" value="10000" />
          </div>
          <div class="guild-row">
            <label>Guild2 Combo:</label
            ><input type="number" id="combo-g2" value="8" />
          </div>
          <!-- Guild3 -->
          <div class="guild-row">
            <label>Guild3 GP:</label
            ><input type="number" id="gp-g3" value="10000" />
          </div>
          <div class="guild-row">
            <label>Guild3 Combo:</label
            ><input type="number" id="combo-g3" value="5" />
          </div>
          <!-- Guild4 -->
          <div class="guild-row">
            <label>Guild4 GP:</label
            ><input type="number" id="gp-g4" value="10000" />
          </div>
          <div class="guild-row">
            <label>Guild4 Combo:</label
            ><input type="number" id="combo-g4" value="12" />
          </div>
        </div>

        <div class="gate-info">
          <h2>ゲート情報</h2>
          <div class="guild-row">
            <label>Gate GP:</label
            ><input type="number" id="gp-gate" value="100000" />
          </div>
          <div class="guild-row">
            <label>Gate Combo:</label
            ><input type="number" id="combo-gate" value="0" />
          </div>
        </div>
      </div>

      <!-- 出撃コマンド作成フォーム -->
      <div>
        <h2>出撃コマンド追加</h2>
        <div id="attackForm">
          <!-- どのギルドが出撃するか選択 -->
          <div class="guild-row">
            <label for="selectGuild">ギルド:</label>
            <select id="selectGuild">
              <option value="g1">Guild1</option>
              <option value="g2">Guild2</option>
              <option value="g3">Guild3</option>
              <option value="g4">Guild4</option>
            </select>
          </div>
          <!-- リーダー or メンバー -->
          <div class="guild-row">
            <label for="selectRole">ロール:</label>
            <select id="selectRole">
              <option value="leader">リーダー</option>
              <option value="member">メンバー</option>
            </select>
          </div>
          <!-- 出撃先のターゲットを選ぶ（最大3つまで） -->
          <div style="margin: 8px 0">ターゲット(最大3つまで):</div>
          <div>
            <label
              ><input type="checkbox" class="chk-target" value="gate" />
              Gate</label
            ><br />
            <label
              ><input type="checkbox" class="chk-target" value="g1" />
              Guild1</label
            ><br />
            <label
              ><input type="checkbox" class="chk-target" value="g2" />
              Guild2</label
            ><br />
            <label
              ><input type="checkbox" class="chk-target" value="g3" />
              Guild3</label
            ><br />
            <label
              ><input type="checkbox" class="chk-target" value="g4" />
              Guild4</label
            >
          </div>
          <!-- コマンド毎のタイムボーナス入力 -->
          <div class="guild-row" style="margin-top: 10px">
            <label>タイムボーナス(%)：</label>
            <input type="number" id="tbAttack" value="0" style="width: 60px" />
          </div>

          <button id="addAttackBtn">追加</button>
        </div>

        <h2>コマンドタイムライン</h2>
        <ul id="commandList">
          <!-- 動的にコマンドカードを追加 -->
        </ul>
        <button onclick="calculateFinal()">最終計算</button>
      </div>
    </div>

    <!-- 計算結果表示欄 -->
    <div id="resultArea">
      <h3>最終結果</h3>
      <div class="result-line">
        <span>Guild1 GP:</span> <span id="result-g1"></span>
      </div>
      <div class="result-line">
        <span>Guild2 GP:</span> <span id="result-g2"></span>
      </div>
      <div class="result-line">
        <span>Guild3 GP:</span> <span id="result-g3"></span>
      </div>
      <div class="result-line">
        <span>Guild4 GP:</span> <span id="result-g4"></span>
      </div>
      <div class="result-line">
        <span>Gate GP:</span> <span id="result-gate"></span>
      </div>
    </div>

    <script>
      /************************************************************
       * グローバル的な設定・データ
       ************************************************************/
      // 各ギルドに対応する色クラス
      const guildColorClass = {
        g1: "guild1",
        g2: "guild2",
        g3: "guild3",
        g4: "guild4",
      };

      // 出撃コマンドを一意に識別するための連番
      let commandCounter = 1;

      // 「出撃～終了」ペアごとに、以下のような構造で格納:
      // {
      //   pairId: "g1_1",
      //   guild: "g1",
      //   role: "leader" or "member",
      //   targets: ["gate","g2"],
      //   timeBonus: 10,
      //   startCmdId: "g1_1_start",
      //   endCmdId:   "g1_1_end"
      // }
      const commandPairs = [];

      // 出撃コマンドで計算した争奪GPや獲得GPを一時保持
      // key: pairId ("g1_1"など)
      // value: { detailSoudatsu: {ターゲット: 奪取量}, totalSoudatsu, gain }
      const pendingActions = {};

      // ドラッグ＆ドロップ用
      let dragSrcEl = null;

      /************************************************************
       * 初期イベントリスナー
       ************************************************************/
      window.addEventListener("DOMContentLoaded", () => {
        // 出撃コマンド追加ボタン
        document
          .getElementById("addAttackBtn")
          .addEventListener("click", onAddAttack);
      });

      /************************************************************
       * 出撃コマンド追加
       ************************************************************/
      function onAddAttack(e) {
        e.preventDefault();
        const guild = document.getElementById("selectGuild").value; // "g1", "g2"...
        const role = document.getElementById("selectRole").value; // "leader" or "member"

        // ターゲットチェック
        const chkTargets = document.querySelectorAll(".chk-target");
        let targets = [];
        for (let c of chkTargets) {
          if (c.checked) {
            targets.push(c.value);
          }
        }
        // 自分自身(guild)は除外する（誤って選んだ場合を想定）
        targets = targets.filter((t) => t !== guild);
        // 最大3つまでに制限
        if (targets.length > 3) {
          alert("ターゲットは最大3つまでです。");
          return;
        }
        // ターゲットが0件ならアラート
        if (targets.length === 0) {
          alert("ターゲットが選択されていません。");
          return;
        }

        // コマンド毎のタイムボーナスを取得
        const timeBonusValue = +document.getElementById("tbAttack").value || 0;

        // ペアID (例: "g1_1", "g2_1" ...)
        const pairId = guild + "_" + commandCounter;
        commandCounter++;

        // start/endのDOM id
        const startCmdId = pairId + "_start";
        const endCmdId = pairId + "_end";

        // commandPairsに記憶
        commandPairs.push({
          pairId,
          guild,
          role,
          targets,
          timeBonus: timeBonusValue, // 出撃コマンド毎のタイムボーナス
          startCmdId,
          endCmdId,
        });

        // タイムラインに「出撃」「終了」の2つのカードを追加
        addCommandCard(
          startCmdId,
          guild,
          "出撃 (" + (role === "leader" ? "リーダー" : "メンバー") + ")",
          guildColorClass[guild]
        );
        addCommandCard(
          endCmdId,
          guild,
          "終了 (" + (role === "leader" ? "リーダー" : "メンバー") + ")",
          guildColorClass[guild]
        );

        // チェックボックスとタイムボーナスをリセット
        for (let c of chkTargets) {
          c.checked = false;
        }
        document.getElementById("tbAttack").value = 0;
      }

      /************************************************************
       * コマンドカード追加（出撃・終了）
       ************************************************************/
      function addCommandCard(cmdId, guild, label, cssClass) {
        const list = document.getElementById("commandList");
        const li = document.createElement("li");
        li.id = cmdId;
        li.className = "command-item " + cssClass;
        li.draggable = true;

        const span = document.createElement("span");
        span.className = "command-label";
        span.textContent = `Guild${guild.slice(1)} ${label}`;
        li.appendChild(span);

        // D&D イベント
        li.addEventListener("dragstart", handleDragStart);
        li.addEventListener("dragover", handleDragOver);
        li.addEventListener("dragleave", handleDragLeave);
        li.addEventListener("drop", handleDrop);
        li.addEventListener("dragend", handleDragEnd);

        list.appendChild(li);
      }

      /************************************************************
       * ドラッグ＆ドロップイベント処理
       ************************************************************/
      function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/html", this.innerHTML);
      }
      function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        return false;
      }
      function handleDragLeave(e) {
        // クラスを外すなど
      }
      function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
          const list = this.parentNode;
          const draggedIndex = Array.prototype.indexOf.call(
            list.children,
            dragSrcEl
          );
          const droppedIndex = Array.prototype.indexOf.call(
            list.children,
            this
          );
          if (draggedIndex < droppedIndex) {
            list.insertBefore(dragSrcEl, this.nextSibling);
          } else {
            list.insertBefore(dragSrcEl, this);
          }
        }
        return false;
      }
      function handleDragEnd(e) {
        // 後処理
      }

      /************************************************************
       * 最終計算ボタン
       * タイムラインを上から順に「出撃⇒終了」を見ていき、
       * 出撃時に pendingActions へ格納し、終了時に反映。
       * さらに「出撃カード」にツールチップ情報を付与。
       ************************************************************/
      function calculateFinal() {
        // まず入力欄から最新のGP・コンボ数を取得
        const gp = {
          g1: +document.getElementById("gp-g1").value,
          g2: +document.getElementById("gp-g2").value,
          g3: +document.getElementById("gp-g3").value,
          g4: +document.getElementById("gp-g4").value,
          gate: +document.getElementById("gp-gate").value,
        };
        const combo = {
          g1: +document.getElementById("combo-g1").value,
          g2: +document.getElementById("combo-g2").value,
          g3: +document.getElementById("combo-g3").value,
          g4: +document.getElementById("combo-g4").value,
          gate: +document.getElementById("combo-gate").value,
        };

        // pendingActionsリセット
        for (const key in pendingActions) {
          delete pendingActions[key];
        }

        console.log("=== 最終計算開始 ===");
        console.log(
          `初期GP => G1:${gp.g1} / G2:${gp.g2} / G3:${gp.g3} / G4:${gp.g4} / Gate:${gp.gate}`
        );

        // タイムラインのカードを上から順に処理
        const list = document.getElementById("commandList");
        const items = list.querySelectorAll("li");

        items.forEach((li) => {
          const cmdId = li.id; // 例: "g1_1_start"

          // どの pairId かを割り出す
          let pairId = cmdId.replace("_start", "");
          pairId = pairId.replace("_end", "");

          // commandPairs からデータを取得
          const pairData = commandPairs.find((p) => p.pairId === pairId);
          if (!pairData) return; // 通常ありえないが念のため

          const isStart = cmdId.endsWith("_start");
          const isEnd = cmdId.endsWith("_end");
          const guild = pairData.guild; // g1, g2, g3, g4
          const role = pairData.role; // "leader" or "member"
          const targets = pairData.targets; // 選択されたターゲット
          const timeBonus = pairData.timeBonus || 0;

          if (isStart) {
            // --- 出撃時（計算のみ） ---
            // リーダー＝2.5% / メンバー＝1.0%
            const rate = role === "leader" ? 0.025 : 0.01;
            let totalSoudatsu = 0;
            let detailSoudatsu = {};

            console.log(
              `[出撃: ${cmdId}] Guild:${guild}, ロール:${role}, ターゲット:${targets.join(
                ","
              )}, タイムボーナス:${timeBonus}%`
            );

            // ターゲット毎に「奪取GP」を計算
            targets.forEach((t) => {
              if (gp[t] !== undefined && t !== guild) {
                const d = Math.floor(gp[t] * rate);
                detailSoudatsu[t] = d; // 個別の奪取量を保持
                totalSoudatsu += d;

                console.log(`  - ターゲット:${t} GP:${gp[t]} => 争奪GP:${d}`);
              }
            });

            // 獲得GP計算: (4000×(1+0.002×コンボ数)+争奪GP合計)×(1+タイムボーナス÷100)
            const base = 4000 * (1 + 0.002 * combo[guild]);
            const gain = (base + totalSoudatsu) * (1 + timeBonus / 100);
            const floorGain = Math.floor(gain);

            console.log(
              `  => 争奪GP合計:${totalSoudatsu}, 獲得GP:${floorGain}`
            );

            // ツールチップ用文字列（複数行にしたい場合は \A + white-space: pre; を使用）
            const tooltipText =
              `ターゲット: ${targets.join(", ")}\A` +
              `タイムボーナス: ${timeBonus}%\A` +
              `獲得GP: ${floorGain}`;

            // 出撃カードにツールチップを設定
            const startLi = document.getElementById(pairData.startCmdId);
            if (startLi) {
              startLi.setAttribute("data-tooltip", tooltipText);
            }

            // pendingActions に保存
            pendingActions[pairId] = {
              detailSoudatsu,
              totalSoudatsu,
              gain: floorGain,
            };
          } else if (isEnd) {
            // --- 終了時（実際に反映） ---
            const pa = pendingActions[pairId];
            if (pa) {
              console.log(`[終了: ${cmdId}] Guild:${guild}`);
              console.log(
                `  反映前 GP => G1:${gp.g1} / G2:${gp.g2} / G3:${gp.g3} / G4:${gp.g4} / Gate:${gp.gate}`
              );

              // detailSoudatsu から、実際にターゲットのGPを減らす
              // ゲートは減らさない & 自分自身も減らさない
              for (const t in pa.detailSoudatsu) {
                if (t !== "gate" && t !== guild) {
                  const subtractAmount = pa.detailSoudatsu[t];
                  gp[t] -= subtractAmount;
                  if (gp[t] < 0) gp[t] = 0;
                  console.log(
                    `  ターゲット:${t} から ${subtractAmount} 減算 => 残りGP:${gp[t]}`
                  );
                } else {
                  console.log(
                    `  ターゲット:${t} からは減算しません (Gateまたは自分自身)`
                  );
                }
              }

              // 自ギルドに獲得GPを加算
              gp[guild] += pa.gain;
              console.log(`  Guild:${guild} に +${pa.gain} => ${gp[guild]}`);

              console.log(
                `  反映後 GP => G1:${gp.g1} / G2:${gp.g2} / G3:${gp.g3} / G4:${gp.g4} / Gate:${gp.gate}`
              );

              // 処理後は削除
              delete pendingActions[pairId];
            }
          }
        });

        console.log("=== 最終計算終了 ===");

        // 計算結果を表示
        document.getElementById("result-g1").textContent = gp.g1;
        document.getElementById("result-g2").textContent = gp.g2;
        document.getElementById("result-g3").textContent = gp.g3;
        document.getElementById("result-g4").textContent = gp.g4;
        document.getElementById("result-gate").textContent = gp.gate;
      }
    </script>
  </body>
</html>
